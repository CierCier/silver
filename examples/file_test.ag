// Example: Using File handles from std.file
import std.io;
import std.file;
import std.mem;

i32 main() {
    printf("=== File I/O Example ===\n\n");
    
    // Write to a file
    printf("--- Writing to file ---\n");
    
    File out = File.open_write("/tmp/silver_test.txt");
    if (!out.valid()) {
        printf("Error: Could not create file\n");
        return 1;
    }
    
    out.debug();
    
    out.write_line("Hello from Silver!");
    out.write_line("This is line 2.");
    out.write_line("And this is line 3.");
    out.write_str("Final line without newline.");
    
    out.close();
    printf("File written successfully.\n");
    
    // Read the file back
    printf("\n--- Reading from file ---\n");
    
    File in = File.open_read("/tmp/silver_test.txt");
    if (!in.valid()) {
        printf("Error: Could not open file for reading\n");
        return 1;
    }
    
    printf("File size: %ld bytes\n", in.size());
    
    // Read line by line
    printf("\nContents:\n");
    printf("--------\n");
    
    i8 buffer[256];
    while (!in.eof()) {
        str line = in.read_line(buffer, 256);
        if (line != 0) {
            printf("%s", line);
        }
    }
    printf("\n--------\n");
    
    in.close();
    
    // Using file_read_all utility
    printf("\n--- Reading entire file ---\n");
    
    i64 size = 0;
    str content = file_read_all("/tmp/silver_test.txt", &size);
    if (content != 0) {
        printf("Read %ld bytes:\n", size);
        printf("%s\n", content);
        free(content);
    }
    
    // Seeking and random access
    printf("\n--- Seeking ---\n");
    
    File f = File.open_read("/tmp/silver_test.txt");
    if (f.valid()) {
        f.seek(6);  // Skip "Hello "
        
        i8 word[20];
        f.read(word, 4);
        word[4] = 0;
        printf("Reading 4 chars from position 6: '%s'\n", word);
        
        printf("Current position: %ld\n", f.tell());
        
        f.rewind();
        printf("After rewind, position: %ld\n", f.tell());
        
        f.close();
    }
    
    // File utilities
    printf("\n--- File Utilities ---\n");
    
    printf("File exists: %s\n", 
           file_exists("/tmp/silver_test.txt") ? "yes" : "no");
    printf("Nonexistent file exists: %s\n",
           file_exists("/tmp/nonexistent_file_12345.txt") ? "yes" : "no");
    
    // Rename file
    printf("\n--- Rename ---\n");
    if (file_rename("/tmp/silver_test.txt", "/tmp/silver_test_renamed.txt")) {
        printf("File renamed successfully.\n");
        printf("Old file exists: %s\n",
               file_exists("/tmp/silver_test.txt") ? "yes" : "no");
        printf("New file exists: %s\n",
               file_exists("/tmp/silver_test_renamed.txt") ? "yes" : "no");
        
        // Rename back for cleanup
        file_rename("/tmp/silver_test_renamed.txt", "/tmp/silver_test.txt");
    }
    
    // Delete file
    printf("\n--- Delete ---\n");
    if (file_delete("/tmp/silver_test.txt")) {
        printf("File deleted successfully.\n");
    }
    printf("File exists after delete: %s\n",
           file_exists("/tmp/silver_test.txt") ? "yes" : "no");
    
    printf("\nDone!\n");
    return 0;
}
